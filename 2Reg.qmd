---
title: "2Reg report"
format:
  html:
    df-print: paged
    toc: true
    number-sections: true
toc: true
crossref:
  chapters: true
editor: visual
execute:
  echo: false
  warning: false
  message: false
  fig.align: center
  dev: png
  cache: false
---

```{r}

#| label: setup
#| cache: true
#| include: false

suppressPackageStartupMessages({
  library(readxl)
  library(dplyr)
  library(tidyr)
  library(purrr)
  library(stringr)
  library(tibble)
  library(openxlsx)
  library(lubridate)
  library(gtsummary)
  library(ggplot2)
  library(rlang)
})

report_file  <- "Отчет_все_записи_12.01.2026-2.xlsx"
dict_file    <- "2Reg_Dictionary_tidy.xlsx"
patients_out <- "2Reg_patients_tidy.xlsx"
ha_out       <- "2Reg_HA_tidy.xlsx"

fmt_int <- function(x) formatC(as.integer(round(x)), format = "f", digits = 0)
fmt_1   <- function(x) formatC(x, format = "f", digits = 1)
fmt_2   <- function(x) formatC(x, format = "f", digits = 2)

save_xlsx <- TRUE
```

```{r}

#| label: etl
#| cache: true
#| include: false

# Ожидается, что эти переменные заданы снаружи:
# report_file, dict_file, patients_out, ha_out, save_xlsx


# ------------------------- helpers -------------------------

norm_txt <- function(x){
  x <- as.character(x)
  x <- str_replace_all(x, "\u00A0", " ")
  x <- str_replace_all(x, "[\u2212\u2013\u2014]", "-")
  x <- str_squish(x)
  x[x == ""] <- NA_character_
  x
}

tp_code <- function(s){
  s <- norm_txt(s); if (is.na(s)) return(NA_character_)
  # единицы (часы/сутки) определяем по части строки с временной точкой
  tp_part <- str_extract(s, "Точка\\s*\\[[^\\]]+\\].*$")
  if (is.na(tp_part)) tp_part <- s
  tl <- str_to_lower(tp_part)
  u <- if (str_detect(tl, "час|\\bч\\b|\\bч\\.")) {
    "h"
  } else if (str_detect(tl, "сут|дн|день")) {
    "d"
  } else {
    "h"
  }

  m <- str_match(tp_part, "Точка\\s*\\[\\s*([-+]?\\d+)\\s*;\\s*([-+]?\\d+)\\s*\\]")
  if (is.na(m[1,1])) return(NA_character_)
  f <- function(z) if (z < 0) paste0("m", abs(z), u) else paste0(z, u)
  paste0(f(as.integer(m[1,2])), "_", f(as.integer(m[1,3])))
}

clean_na <- function(x){
  x <- as.character(x)
  x <- str_replace_all(x, "[\r\n]", " ")
  x <- str_squish(x)
  xl <- str_to_lower(x)
  x[xl %in% c("нет значения","нет данных","n/a","na")] <- NA_character_
  x[x == ""] <- NA_character_
  x
}

to_num <- function(x){
  x <- clean_na(x)
  x <- str_split_fixed(x, "\\s*\\|\\s*", 2)[,1]
  m <- str_extract(x, "[-+]?\\d+(?:[\\.,]\\d+)?")
  as.numeric(str_replace_all(m, ",", "."))
}

split_val_unit <- function(x, impute_ineq = FALSE){
  x <- clean_na(x)
  x <- str_split_fixed(x, "\\s*\\|\\s*", 2)[,1]
  m <- str_match(x, "^\\s*([<>]=?|≤|≥)?\\s*([-+]?\\d+(?:[\\.,]\\d+)?)\\s*(.*)$")
  op <- str_trim(m[,2])
  val <- suppressWarnings(as.numeric(str_replace_all(m[,3], ",", ".")))
  unit <- str_squish(m[,4]); unit[unit == ""] <- NA_character_
  if (impute_ineq) val <- case_when(
    op %in% c("<","<=","≤") ~ val/2,
    op %in% c(">",">=","≥") ~ val*2,
    TRUE ~ val
  )
  list(value = val, unit = unit)
}

reorder_units <- function(df, bases){
  bases <- intersect(bases, names(df))
  fixed <- intersect(c("pat_record_id","timepoint"), names(df))
  pairs <- unlist(lapply(bases, function(b){
    u <- paste0(b, "_unit")
    if (u %in% names(df)) c(b, u) else b
  }), use.names = FALSE)
  used <- unique(c(fixed, pairs))
  rest <- setdiff(names(df), used)
  df %>% select(any_of(fixed), any_of(pairs), all_of(rest))
}

# Длительность в часы: "HH:MM" / "HH:MM:SS" -> numeric hours, иначе число трактуем как часы.
# "0:00" (и варианты с пробелами) даёт 0.
dur_to_hours <- function(x){
  x <- clean_na(x)
  x <- str_split_fixed(x, "\\s*\\|\\s*", 2)[,1]

  m <- str_match(x, "^\\s*(\\d{1,3})\\s*:\\s*(\\d{1,2})(?::\\s*(\\d{1,2}))?\\s*$")
  is_time <- !is.na(m[,1])

  out <- rep(NA_real_, length(x))
  if (any(is_time)) {
    hh <- as.numeric(m[is_time,2])
    mm <- as.numeric(m[is_time,3])
    ss <- suppressWarnings(as.numeric(m[is_time,4])); ss[is.na(ss)] <- 0
    out[is_time] <- hh + mm/60 + ss/3600
  }
  if (any(!is_time)) out[!is_time] <- to_num(x[!is_time])

  # Явно нормализуем -0 к 0 (на всякий случай)
  out[!is.na(out) & abs(out) < 1e-12] <- 0
  out
}



# ------------------------- datetime helpers -------------------------

# Универсальный парсер дат/времени: строки разных форматов + Excel-числа.
# tz оставляем "UTC" как "нейтральную" шкалу времени.
parse_dt <- function(x, tz = "UTC") {
  x <- clean_na(x)
  x <- str_replace_all(x, "\u00A0", " ")
  x <- str_squish(x)
  x[x == ""] <- NA_character_

  out <- rep(as.POSIXct(NA, tz = tz), length(x))

  # Excel serial numbers (дата как число)
  x_num <- suppressWarnings(as.numeric(str_replace_all(x, ",", ".")))
  is_num <- !is.na(x_num) & str_detect(x, "^\\d+(?:[\\.,]\\d+)?$")
  if (any(is_num)) {
    out[is_num] <- as.POSIXct(x_num[is_num] * 86400, origin = "1899-12-30", tz = tz)
  }

  idx <- which(!is_num & !is.na(x))
  if (length(idx)) {
    out[idx] <- suppressWarnings(lubridate::parse_date_time(
      x[idx],
      orders = c("dmy HMS","dmy HM","dmy", "ymd HMS","ymd HM","ymd", "mdy HMS","mdy HM","mdy"),
      tz = tz
    ))
  }
  out
}

# Добавляет новую datetime-колонку (new) из исходной (src), если src есть; иначе создаёт NA.
add_dt <- function(df, src, new, tz = "UTC") {
  if (src %in% names(df)) {
    df[[new]] <- suppressWarnings(parse_dt(df[[src]], tz = tz))
  } else {
    df[[new]] <- as.POSIXct(NA, tz = tz)
  }
  df
}

# ------------------------- dictionary -------------------------

dict <- read_excel(dict_file, col_types = "text") %>%
  mutate(across(everything(), as.character))

# dataset обязателен 
if (!("dataset" %in% names(dict))) stop("В словаре должна быть колонка dataset (patients_tidy / HA_tidy).")
if (!all(c("short","ru") %in% names(dict))) stop("В словаре должны быть колонки short и ru.")
if (!("kind" %in% names(dict))) dict$kind <- NA_character_

dict <- dict %>%
  transmute(
    dataset = norm_txt(dataset),
    short   = norm_txt(short),
    ru      = norm_txt(ru),
    kind    = norm_txt(kind)
  ) %>%
  mutate(
    dataset = case_when(
      str_to_lower(dataset) %in% c("patients_tidy","patients","patient") ~ "patients",
      str_to_lower(dataset) %in% c("ha_tidy","ha") ~ "ha",
      TRUE ~ str_to_lower(dataset)
    )
  )

# Словарь для patients_tidy: только static/time
dict_pat <- dict %>%
  filter(dataset == "patients") %>%
  filter(kind %in% c("static","time"))

ds <- filter(dict_pat, kind == "static")
dt <- filter(dict_pat, kind == "time")
ru_to_short <- setNames(dt$short, dt$ru)

# Словарь для HA_tidy: для подписей
dict_ha <- dict %>%
  filter(dataset == "ha") %>%
  filter(!is.na(short), short != "") %>%
  group_by(short) %>%
  summarise(ru = first(na.omit(ru)), .groups = "drop")

# --------------------- sheet extraction ----------------------

read_sheet_norm <- function(f, sh){
  read_excel(
    f, sheet = sh, col_names = FALSE,
    col_types = "text",
    na = c("", "Нет данных", "Нет значения", "Нет значения
", "Нет данных ", "Нет значения
")
  ) %>%
    mutate(across(everything(), norm_txt))
}

extract_one_sheet <- function(x){
  # x: уже прочитанный и нормализованный лист (data.frame / tibble)
  x <- as.data.frame(x, stringsAsFactors = FALSE)
  x[] <- lapply(x, as.character)

  x_mat <- as.matrix(x)
  nr <- nrow(x_mat); nc <- ncol(x_mat)

  cell <- function(i,j) if (i<1||i>nr||j<1||j>nc) NA_character_ else x_mat[i,j]
  empty_row <- function(i) all(is.na(x_mat[i, ]))
  sect <- function(i){
    c1 <- x_mat[i,1]
    if (is.na(c1)) return(FALSE)
    if (nc < 2) return(TRUE)
    all(is.na(x_mat[i, 2:nc]))
  }

  out <- list()
  add <- function(k,v){
    if (is.na(k) || is.na(v)) return()
    if (!is.null(out[[k]]) && !is.na(out[[k]])) {
      if (!str_detect(out[[k]], fixed(v))) out[[k]] <<- paste(out[[k]], v, sep=" | ")
    } else out[[k]] <<- v
  }

  # Простой список "ключ-значение" (1-я колонка + все остальные)
  for (i in seq_len(nr)) {
    k <- cell(i,1)
    if (is.na(k) || k == "Параметр") next
    if (nc >= 2) {
      v <- x_mat[i, 2:nc]
      v <- v[!is.na(v)]
      if (length(v)) add(k, paste(v, collapse=" | "))
    }
  }

  # Таблицы с заголовком "Параметр"
  pr <- which(x_mat[,1] == "Параметр")
  for (st in pr){
    if (nc < 2) next

    hdr <- x_mat[st, 2:nc]
    cols <- which(!is.na(hdr)) + 1
    hs <- hdr[!is.na(hdr)]
    tt <- any(str_detect(hs, regex("\\bТочка\\b", TRUE)))

    title <- NA_character_
    if (st > 1) for (t in seq(st-1, 1, -1)) if (sect(t)) { title <- cell(t,1); break }

    pref <- NA_character_
    if (!is.na(title)) {
      if (str_detect(str_to_upper(title), "КЛЕТКИ"))   pref <- "Клетки крови"
      if (str_detect(str_to_upper(title), "БИОХИМИЯ")) pref <- "Биохимия"
    }

    i <- st + 1
    while (i <= nr){
      rn <- cell(i,1)
      if (is.na(rn)) { if (empty_row(i)) break; i <- i+1; next }
      if (rn == "Параметр") break

      rn2 <- rn
      if (tt && rn == "Дата проведения" && !is.na(title) &&
          str_detect(str_to_upper(title), "КЛИНИЧЕСКАЯ ОЦЕНКА")) rn2 <- "Дата клинической оценки"
      if (tt && rn == "Дата пробы" && !is.na(pref)) rn2 <- paste("Дата пробы", pref)

      for (k in seq_along(cols)){
        v <- cell(i, cols[k]); if (is.na(v)) next
        key <- if (tt) norm_txt(paste(rn2, hs[k])) else norm_txt(paste(hs[k], rn2))
        add(key, v)
      }
      i <- i + 1
    }
  }

  out
}

# --------------------- patients_tidy ----------------------

sheets <- excel_sheets(report_file)

# Читаем каждый лист ровно один раз (I/O win), дальше используем кэш в памяти
raw_sheets <- setNames(map(sheets, ~ read_sheet_norm(report_file, .x)), sheets)

patients_tidy <- map_dfr(raw_sheets, function(x){
  m <- extract_one_sheet(x)
  nm <- names(m)

  static <- setNames(
    as.list(map_chr(norm_txt(ds$ru), ~ {v <- m[[.x]]; if (is.null(v)) NA_character_ else v})),
    ds$short
  ) %>% as_tibble()

  last  <- m[[norm_txt("Фамилия автора")]]
  first <- m[[norm_txt("Имя автора")]]
  author <- str_squish(paste(last, first))
  if (is.null(last) && is.null(first)) author <- NA_character_
  if (!is.null(last) && is.null(first)) author <- str_squish(last)
  if (is.null(last) && !is.null(first)) author <- str_squish(first)

dyn_keys <- nm[grepl("Точка", nm, fixed = TRUE)]
dyn_vals <- as.character(unlist(m[dyn_keys], use.names = FALSE))
ru_base  <- norm_txt(sub("Точка.*$", "", dyn_keys))

dyn <- tibble(
  timepoint = vapply(dyn_keys, tp_code, character(1)),
  var       = unname(ru_to_short[ru_base]),
  value     = dyn_vals
) %>%
  filter(!is.na(timepoint), !is.na(var)) %>%
  group_by(timepoint, var) %>%
  summarise(value = paste(na.omit(unique(value)), collapse = " | "), .groups = "drop")

  dyn_w <- if (nrow(dyn) == 0) {
    tibble(timepoint = NA_character_)
  } else {
    dw <- reshape(as.data.frame(dyn), idvar = "timepoint", timevar = "var", direction = "wide")
    names(dw) <- sub("^value\\.", "", names(dw))
    as_tibble(dw)
  }

  out <- bind_cols(dyn_w, static[rep(1, nrow(dyn_w)), , drop = FALSE])

  if (!("pat_record_id" %in% names(out))) {
    id <- m[[norm_txt("ID записи")]]
    out$pat_record_id <- if (is.null(id)) NA_character_ else id
  }

  out$record_author <- author

  out %>%
    relocate(record_author, .after = pat_record_id) %>%
    select(pat_record_id, record_author, timepoint, everything())
}) %>%
  mutate(across(everything(), clean_na))

num_cols <- c(
  "SOFA","VIS2020","avg_BP","leucocytes","neutrophils","lymphocytes","thrombocytes",
  "age_yr","age_m","BMI","charlson_index",
  "vasopressors_dur_days","vasopressors_dur_hours",
  "MV_dur_days","MV_dur_hours",
  "RRT_dur_days","RRT_dur_hours",
  "ECMO_dur_days","ECMO_dur_hours",
  "SpFiO2","PaFiO2"
)
num_cols <- intersect(num_cols, names(patients_tidy))
patients_tidy <- patients_tidy %>% mutate(across(all_of(num_cols), to_num))

unit_bases <- c("lactate","creatinine","albumin","C_react_protein","procalcitonin",
                "D_dimer","fibrinogen","bilirubin_total")
unit_bases <- intersect(unit_bases, names(patients_tidy))

for (col in unit_bases) {
  sp <- split_val_unit(patients_tidy[[col]], impute_ineq = (col == "procalcitonin"))
  patients_tidy[[col]] <- sp$value
  patients_tidy[[paste0(col, "_unit")]] <- sp$unit
}
patients_tidy <- reorder_units(patients_tidy, unit_bases)

# ------------------------ HA_tidy -------------------------

ha_extract <- function(raw){
  raw <- as.data.frame(raw, stringsAsFactors = FALSE)
  raw[] <- lapply(raw, as.character)
  c1 <- names(raw)[1]; vc <- names(raw)[-1]

  id <- raw %>%
    filter(str_to_lower(.data[[c1]]) == "id записи") %>%
    pull(!!rlang::sym(vc[1])) %>% first()

  s <- which(str_to_upper(raw[[c1]]) == "ПАРАМЕТРЫ ГЕМОСОРБЦИИ")[1]
  if (is.na(s)) return(tibble())
  e <- which(str_to_upper(raw[[c1]]) == "КЛИНИЧЕСКАЯ ОЦЕНКА")[1]
  if (is.na(e) || e <= s) e <- nrow(raw) + 1

  b <- raw[(s+1):(e-1), , drop = FALSE]
  need <- c("Параметр","Тип устройства","Серийный номер устройства","Начало процедуры",
            "Длительность ГС (ч)","Средняя скорость потока крови (мл/мин)",
            "Антикоагуляция","Антикоагуляция (другой)",
            "Комбинация с другими экстракорпоральными методами","Нежелательные явления")
  b <- b %>% filter(.data[[c1]] %in% need)
  if (!any(b[[c1]] == "Параметр")) return(tibble())

  pr <- b %>% filter(.data[[c1]] == "Параметр") %>% slice(1)
  pn <- as.character(pr[1, vc]); idx <- which(!is.na(pn) & pn != "")
  if (!length(idx)) return(tibble())

  gv <- function(lbl, col) b %>% filter(.data[[c1]] == lbl) %>%
    pull(!!rlang::sym(col)) %>% first()

  map_dfr(idx, function(k){
    col <- vc[k]
    tibble(
      pat_record_id = id,
      HA_parameter = pn[k],
      HA_cartrige_type = gv("Тип устройства", col),
      HA_serial_number = gv("Серийный номер устройства", col),
      HA_start_datetime = gv("Начало процедуры", col),
      HA_duration = gv("Длительность ГС (ч)", col),
      HA_avg_blood_flow = gv("Средняя скорость потока крови (мл/мин)", col),
      HA_anticoagulation = gv("Антикоагуляция", col),
      HA_anticoagulation_other = gv("Антикоагуляция (другой)", col),
      HA_other_methods = gv("Комбинация с другими экстракорпоральными методами", col),
      HA_adverse_effects = gv("Нежелательные явления", col)
    )
  }) %>% filter(!is.na(HA_parameter) & HA_parameter != "")
}

HA_tidy <- map_dfr(raw_sheets, ha_extract) %>%
  mutate(
    HA_avg_blood_flow = to_num(HA_avg_blood_flow),
    HA_duration = round(dur_to_hours(HA_duration), 2)
  )

# Добавляем количество процедур с разными картриджами по каждому пациенту
HA_counts <- HA_tidy %>%
  mutate(.ct = str_to_upper(norm_txt(HA_cartrige_type))) %>%
  group_by(pat_record_id) %>%
  summarise(
    CT_count = sum(.ct == "CT", na.rm = TRUE),
    LPS_count = sum(.ct == "LPS", na.rm = TRUE),
    .groups = "drop"
  )

HA_tidy <- HA_tidy %>%
  left_join(HA_counts, by = "pat_record_id") %>%
  mutate(
    CT_count = if_else(is.na(CT_count), 0L, as.integer(CT_count)),
    LPS_count = if_else(is.na(LPS_count), 0L, as.integer(LPS_count))
  )

# ------------------ postprocess (no повторов в аналитике) ------------------

# patients: datetime-колонки (создаём *всегда*, даже если исходной колонки нет)
patients_tidy <- patients_tidy %>%
  add_dt("ICU_in_datetime", "ICU_in_dt") %>%
  add_dt("antibiotics_start_datetime", "antibiotics_start_dt") %>%
  add_dt("RRT_start", "RRT_start_dt") %>%
  add_dt("RRT_resolution", "RRT_resolution_dt") %>%
  add_dt("MV_start", "MV_start_dt") %>%
  add_dt("MV_resolution", "MV_resolution_dt")

# VIS2020: анализируем только >0, но исходник сохраняем
if ("VIS2020" %in% names(patients_tidy)) {
  patients_tidy <- patients_tidy %>%
    mutate(
      VIS2020_raw = VIS2020,
      VIS2020 = if_else(!is.na(VIS2020) & VIS2020 > 0, VIS2020, NA_real_)
    )
}

# NLR: один раз на всех timepoint
if (all(c("neutrophils","lymphocytes") %in% names(patients_tidy))) {
  patients_tidy <- patients_tidy %>%
    mutate(
      NLR = if_else(
        !is.na(neutrophils) & !is.na(lymphocytes) & lymphocytes > 0,
        neutrophils / lymphocytes,
        NA_real_
      )
    )
}

# fibrinogen: приводим g/dl -> mg/dl (×1000) один раз, чтобы везде было одинаково
if (all(c("fibrinogen","fibrinogen_unit") %in% names(patients_tidy))) {
  fu <- str_to_lower(str_squish(as.character(patients_tidy$fibrinogen_unit)))
  is_gdl  <- !is.na(fu) & str_detect(fu, "^(г|g)\\s*/\\s*(дл|dl)\\.?$")
  is_mgdl <- !is.na(fu) & str_detect(fu, "^(мг|mg)\\s*/\\s*(дл|dl)\\.?$")
  patients_tidy$fibrinogen <- ifelse(is_gdl & !is.na(patients_tidy$fibrinogen),
                                     patients_tidy$fibrinogen * 1000,
                                     patients_tidy$fibrinogen)
  patients_tidy$fibrinogen_unit <- ifelse(is_gdl | is_mgdl, "мг/дл", patients_tidy$fibrinogen_unit)
}

# HA: datetime + нормализация типа картриджа
HA_tidy <- HA_tidy %>%
  add_dt("HA_start_datetime", "HA_start_dt") %>%
  mutate(
    HA_cartrige_type_std = str_to_upper(str_squish(as.character(HA_cartrige_type)))
  )

# Когорты для парных сравнений (LPS в первые 72 часа от ICU)
icu_by_id <- patients_tidy %>%
  group_by(pat_record_id) %>%
  summarise(ICU_in_dt = first(na.omit(ICU_in_dt)), .groups = "drop") %>%
  mutate(ICU_in_plus72 = ICU_in_dt + hours(72))

ids_lps_72h <- HA_tidy %>%
  inner_join(icu_by_id, by = "pat_record_id") %>%
  filter(
    HA_cartrige_type_std == "LPS",
    !is.na(HA_start_dt),
    !is.na(ICU_in_dt),
    HA_start_dt >= ICU_in_dt,
    HA_start_dt <= ICU_in_plus72
  ) %>%
  distinct(pat_record_id)

# Показания к гемосорбции: читаем один раз (если файл есть)
diag_file <- "2Reg_diagnoses.xlsx"
if (!file.exists(diag_file) && file.exists("/mnt/data/2Reg_diagnoses.xlsx")) {
  diag_file <- "/mnt/data/2Reg_diagnoses.xlsx"
}

diag_wide <- NULL
if (file.exists(diag_file)) {
  diag_wide <- tryCatch(
    readxl::read_excel(diag_file, sheet = 2),
    error = function(e) NULL
  )
}

# ------------------------ output --------------------------

if (isTRUE(save_xlsx)) {
  write.xlsx(patients_tidy, patients_out, asTable = TRUE, overwrite = TRUE)
  write.xlsx(HA_tidy, ha_out, asTable = TRUE, overwrite = TRUE)
}
```

```{r}
#| label: gtsummary_pat
#| cache: true
#| echo: false

tp_top <- "m12h_0h"
tps_bottom <- c("m12h_0h", "48h_72h", "4d_6d", "7d_10d")
show_antibiotics <- FALSE  # временно скрыто

# RU-лейблы из словаря (dict_pat уже создан в ETL)
ru_map <- dict_pat %>%
  distinct(short, ru) %>%
  filter(!is.na(short), short != "", !is.na(ru), ru != "") %>%
  tibble::deframe()

ru_or <- function(key) {
  x <- unname(ru_map[[key]])
  if (is.null(x) || is.na(x) || x == "") key else x
}

unit_mode <- function(x) {
  x <- as.character(x)
  x <- x[!is.na(x) & x != ""]
  if (!length(x)) return(NA_character_)
  names(sort(table(x), decreasing = TRUE))[1]
}

lab_u <- function(base_ru, unit) {
  if (!is.na(unit) && unit != "") paste0(base_ru, " (", unit, ")") else base_ru
}

# ---------------- data: верх (только m12h_0h) ----------------
pt_top <- patients_tidy %>%
  filter(timepoint == tp_top) %>%
  distinct(pat_record_id, .keep_all = TRUE) %>%
  mutate(
    vasopressors_used = case_when(
      str_to_lower(vasopressors_if_used) == "да"  ~ "Да",
      str_to_lower(vasopressors_if_used) == "нет" ~ "Нет",
      TRUE ~ NA_character_
    ),
    vasopressors_used = factor(vasopressors_used, levels = c("Да","Нет"))
  )

if (isTRUE(show_antibiotics) && "antibiotics_start_dt" %in% names(pt_top)) {
  pt_top <- pt_top %>%
    mutate(
      antibiotics_started = if_else(!is.na(antibiotics_start_dt), "Да", "Нет"),
      antibiotics_started = factor(antibiotics_started, levels = c("Да","Нет"))
    )
}

# ---------------- HA: время старта "Гемоперфузия 1" + counts ----------------
ha1 <- HA_tidy %>%
  filter(HA_parameter == "Гемоперфузия 1") %>%
  group_by(pat_record_id) %>%
  summarise(
    HA1_start_dt = if (all(is.na(HA_start_dt))) as.POSIXct(NA, tz = "UTC") else min(HA_start_dt, na.rm = TRUE),
    .groups = "drop"
  )

ha_counts <- HA_tidy %>%
  distinct(pat_record_id, CT_count, LPS_count) %>%
  mutate(
    CT_count  = coalesce(as.integer(CT_count),  0L),
    LPS_count = coalesce(as.integer(LPS_count), 0L),
    devices_total = CT_count + LPS_count
  )

pt_top <- pt_top %>%
  left_join(ha1, by = "pat_record_id") %>%
  left_join(ha_counts, by = "pat_record_id") %>%
  mutate(
    icu_to_HA1_hours = round(as.numeric(difftime(HA1_start_dt, ICU_in_dt, units = "hours")), 1),

    # исключаем 0 из разбивки по типам устройств на пациента (0 -> NA)
    CT_count_pos      = if_else(!is.na(CT_count) & CT_count > 0, as.integer(CT_count), NA_integer_),
    LPS_count_pos     = if_else(!is.na(LPS_count) & LPS_count > 0, as.integer(LPS_count), NA_integer_),
    devices_total_pos = if_else(!is.na(devices_total) & devices_total > 0, as.integer(devices_total), NA_integer_),

    # ----- RRT/MV required относительно HA1_start_dt -----
    RRT_required = case_when(
      is.na(RRT_start_dt) ~ "Нет",
      is.na(HA1_start_dt) ~ NA_character_,
      HA1_start_dt >= (RRT_start_dt - hours(12)) &
        (is.na(RRT_resolution_dt) | HA1_start_dt <= RRT_resolution_dt) ~ "Да",
      TRUE ~ "Нет"
    ),
    MV_required = case_when(
      is.na(MV_start_dt) ~ "Нет",
      is.na(HA1_start_dt) ~ NA_character_,
      HA1_start_dt >= (MV_start_dt - hours(12)) &
        (is.na(MV_resolution_dt) | HA1_start_dt <= MV_resolution_dt) ~ "Да",
      TRUE ~ "Нет"
    ),

    RRT_required = factor(RRT_required, levels = c("Да","Нет")),
    MV_required  = factor(MV_required,  levels = c("Да","Нет"))
  )

# ---------------- верхняя часть  ----------------
vars_top <- c(
  "age_yr","sex","BMI","ICU_6_month_history","from_other_ICU_transfer",
  "icu_to_HA1_hours",
  "vasopressors_used","RRT_required","MV_required",
  "charlson_index",
  "pat_bacteremia","pat_gram_negative","pat_gram_positive","pat_fungal",
  "CT_count_pos","LPS_count_pos","devices_total_pos",
  "HA_efficency_CGI_E","outcome"
)

lbl_top <- list(
  age_yr = ru_or("age_yr"),
  sex = ru_or("sex"),
  BMI = ru_or("BMI"),
  ICU_6_month_history = ru_or("ICU_6_month_history"),
  from_other_ICU_transfer = ru_or("from_other_ICU_transfer"),
  icu_to_HA1_hours = "Время между поступлением в ОРИТ и началом ГС, ч",
  vasopressors_used = "Потребность в вазопрессорах",
  RRT_required = "Потребность в ЗПТ",
  MV_required  = "Потребность в ИВЛ",
  charlson_index = ru_or("charlson_index"),
  pat_bacteremia    = ru_or("pat_bacteremia"),
  pat_gram_negative = ru_or("pat_gram_negative"),
  pat_gram_positive = ru_or("pat_gram_positive"),
  pat_fungal        = ru_or("pat_fungal"),
  CT_count_pos = "Устройств CT на пациента, n",
  LPS_count_pos = "Устройств LPS на пациента, n",
  devices_total_pos = "Всего устройств на пациента, n",
  HA_efficency_CGI_E = ru_or("HA_efficency_CGI_E"),
  outcome = ru_or("outcome")
)

type_top  <- list(
  vasopressors_used ~ "dichotomous",
  RRT_required ~ "dichotomous",
  MV_required ~ "dichotomous"
)

value_top <- list(
  vasopressors_used ~ "Да",
  RRT_required ~ "Да",
  MV_required ~ "Да"
)

if (isTRUE(show_antibiotics) && "antibiotics_started" %in% names(pt_top)) {
  vars_top <- c(vars_top, "antibiotics_started")
  lbl_top$antibiotics_started <- "Антибиотики начаты (дата заполнена)"
  type_top  <- c(type_top,  list(antibiotics_started ~ "dichotomous"))
  value_top <- c(value_top, list(antibiotics_started ~ "Да"))
}

lbl_top <- lbl_top[names(lbl_top) %in% vars_top]

tbl_top <- pt_top %>%
  select(any_of(vars_top)) %>%
  tbl_summary(
    type = type_top,
    value = value_top,
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{p}% ({n})"
    ),
    label = lbl_top,
    missing = "no"
  )

# ------------ показания к гемосорбции (diag_wide уже загружен в ETL) ------------
tbl_indications <- NULL
diag_n <- NA_integer_

if (!is.null(diag_wide) && "pat_record_id" %in% names(diag_wide)) {
  diag_wide2 <- diag_wide %>%
    mutate(pat_record_id = as.character(pat_record_id)) %>%
    semi_join(pt_top %>% select(pat_record_id), by = "pat_record_id")

  diag_n <- nrow(diag_wide2)
  diag_cols <- setdiff(names(diag_wide2), "pat_record_id")

  count_yes <- function(v) {
    v <- as.character(v)
    v <- str_to_lower(str_squish(v))
    sum(v %in% c("1","да","yes","true"), na.rm = TRUE)
  }

  if (diag_n > 0 && length(diag_cols) > 0) {
    dx_order <- diag_wide2 %>%
      summarise(across(all_of(diag_cols), count_yes)) %>%
      pivot_longer(everything(), names_to = "dx", values_to = "n_yes") %>%
      arrange(desc(n_yes), dx) %>%
      pull(dx)

    diag_tbl <- diag_wide2 %>%
      mutate(across(all_of(dx_order), ~ factor(
        if_else(as.character(.) %in% c("1","Да","да","TRUE","true"), "Да", "Нет"),
        levels = c("Да","Нет")
      ))) %>%
      select(all_of(dx_order))

    tbl_indications <- diag_tbl %>%
      tbl_summary(
        type = everything() ~ "dichotomous",
        value = everything() ~ "Да",
        statistic = all_categorical() ~ "{p}% ({n})",
        label = rlang::set_names(as.list(dx_order), dx_order),
        missing = "no"
      )
  }
}

# ---------------- нижняя часть (колонки по timepoint) ----------------
pt_bottom <- patients_tidy %>%
  filter(timepoint %in% tps_bottom) %>%
  mutate(timepoint = factor(timepoint, levels = tps_bottom)) %>%
  distinct(pat_record_id, timepoint, .keep_all = TRUE)

u_lactate <- unit_mode(pt_bottom$lactate_unit)
u_creat   <- unit_mode(pt_bottom$creatinine_unit)
u_albumin <- unit_mode(pt_bottom$albumin_unit)
u_crp     <- unit_mode(pt_bottom$C_react_protein_unit)
u_pct     <- unit_mode(pt_bottom$procalcitonin_unit)
u_ddimer  <- unit_mode(pt_bottom$D_dimer_unit)
u_fibr    <- unit_mode(pt_bottom$fibrinogen_unit)

vars_bottom <- c(
  "SOFA","VIS2020","PaFiO2",
  "lactate","creatinine","albumin","C_react_protein",
  "procalcitonin","D_dimer","fibrinogen",
  "leucocytes","lymphocytes","neutrophils","NLR",
  "thrombocytes"
)

lbl_bottom <- list(
  SOFA = ru_or("SOFA"),
  VIS2020 = ru_or("VIS2020"),
  PaFiO2 = ru_or("PaFiO2"),
  lactate = lab_u(ru_or("lactate"), u_lactate),
  creatinine = lab_u(ru_or("creatinine"), u_creat),
  albumin = lab_u(ru_or("albumin"), u_albumin),
  C_react_protein = lab_u(ru_or("C_react_protein"), u_crp),
  procalcitonin = lab_u(ru_or("procalcitonin"), u_pct),
  D_dimer = lab_u(ru_or("D_dimer"), u_ddimer),
  fibrinogen = lab_u(ru_or("fibrinogen"), u_fibr),
  leucocytes = ru_or("leucocytes"),
  lymphocytes = ru_or("lymphocytes"),
  neutrophils = ru_or("neutrophils"),
  NLR = "NLR (нейтрофилы/лимфоциты)",
  thrombocytes = ru_or("thrombocytes")
)
lbl_bottom <- lbl_bottom[names(lbl_bottom) %in% vars_bottom]

tbl_bottom <- pt_bottom %>%
  select(timepoint, any_of(vars_bottom)) %>%
  tbl_summary(
    by = timepoint,
    statistic = list(all_continuous() ~ "{median} ({p25}, {p75})"),
    digits = list(NLR ~ 2),
    label = lbl_bottom,
    missing = "no"
  )

# ---------------- итог: верх (+показания) + низ ----------------
tbls <- list(tbl_top)
hdrs <- c("Общие характеристики")

if (!is.null(tbl_indications)) {
  tbls <- c(tbls, list(tbl_indications))
  hdrs <- c(hdrs, sprintf("Показания к гемосорбции (n=%d)", diag_n))
}

tbls <- c(tbls, list(tbl_bottom))
hdrs <- c(hdrs, "Параметры по временным точкам")

tbl_pat <- tbl_stack(tbls, group_header = hdrs) %>%
  modify_table_styling(rows = row_type == "label", columns = label, text_format = "bold") %>%
  modify_table_styling(rows = row_type %in% c("group_header", "group"), columns = label, text_format = "bold") %>%
  modify_caption("**2Reg: сводная таблица по пациентам**") %>%
  modify_header(label = "**Параметр**")

tbl_pat
```

```{r}

#| label: ha_gtsummary_compact
#| cache: true
#| echo: false

`%||%` <- function(x, y) {
  if (!is.null(x) && length(x) && !is.na(x) && as.character(x) != "") x else y
}

sq <- function(x) str_squish(as.character(x))
norm0 <- function(x){
  x <- str_to_lower(sq(x))
  x <- str_replace_all(x, "\u00A0", " ")
  str_squish(x)
}

# используем dict_ha, который уже создан в ETL (без повторного read_excel)
ha_label_map <- tibble::deframe(dict_ha)  # names = short, values = ru
label_list <- rlang::set_names(as.list(ha_label_map), names(ha_label_map))

ha_proc <- HA_tidy %>%
  mutate(
    HA_anticoagulation_cat = case_when(
      HA_anticoagulation == "Цитрат"  ~ "Цитрат",
      HA_anticoagulation == "Гепарин" ~ "Гепарин",
      HA_anticoagulation == "Другой" &
        norm0(coalesce(HA_anticoagulation_other, "")) %in% c("без антикоагуляции") ~ "Без антикоагуляции",
      HA_anticoagulation == "Другой" ~ "Другой",
      TRUE ~ "Другой"
    ),

    other_norm = norm0(coalesce(HA_other_methods, "")),
    has_rrt  = str_detect(other_norm, "гемодиафильтрац|гемодиализ|гемофильтрац"),
    has_ecmo = str_detect(other_norm, "экмо"),

    HA_other_methods_cat = case_when(
      other_norm == "" ~ "Не применялась",
      other_norm %in% c("не применялась", "не применялось", "нет", "не было", "-", "—") ~ "Не применялась",
      has_rrt ~ "ЗПТ",
      has_ecmo ~ "ЭКМО",
      TRUE ~ "Другое"
    ) %>% factor(levels = c("ЗПТ", "ЭКМО", "Не применялась", "Другое")),

    rrt_grp = if_else(has_rrt, "В комбинации с ЗПТ", "Изолированная гемосорбция") %>%
      factor(levels = c("В комбинации с ЗПТ", "Изолированная гемосорбция")),

    adverse_effects_filled = if_else({
      x <- norm0(HA_adverse_effects)
      !(is.na(x) | x %in% c("", "нет", "не было", "-", "—"))
    }, "Да", "Нет")
  ) %>%
  select(-other_norm, -has_rrt, -has_ecmo)

# переменные, которые не имеет смысла показывать в разрезе rrt_grp (оставляем только All)
no_strat_vars <- c("HA_other_methods_cat")

tbl <- ha_proc %>%
  select(
    rrt_grp,
    HA_other_methods_cat,   # наверху
    HA_cartrige_type,
    HA_duration,
    HA_avg_blood_flow,
    HA_anticoagulation_cat,
    adverse_effects_filled
  ) %>%
  tbl_summary(
    by = rrt_grp,
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{p}% ({n})"
    ),
    missing = "no",
    sort = all_categorical() ~ "frequency",
    label = c(
      label_list,
      list(
        HA_anticoagulation_cat = ha_label_map[["HA_anticoagulation"]] %||% "Антикоагуляция",
        HA_other_methods_cat   = ha_label_map[["HA_other_methods"]] %||% "Комбинация с другими экстракорпоральными методами",
        adverse_effects_filled = "Нежелательные явления: указано"
      )
    )
  ) %>%
  add_overall(last = FALSE) %>%
  modify_header(
    stat_0 ~ "**All**",
    stat_1 ~ "**В комбинации с ЗПТ**",
    stat_2 ~ "**Изолированная гемосорбция**"
  ) %>%
  modify_table_body(
    ~ .x %>%
      mutate(
        stat_1 = if_else(variable %in% no_strat_vars, "", stat_1),
        stat_2 = if_else(variable %in% no_strat_vars, "", stat_2)
      )
  ) %>%
  modify_caption("**2Reg: сводная таблица по сорбциям**") %>%
  bold_labels()

tbl
```

```{r}
#| label: gtsummary_m12h_0h_48h_72h
#| cache: true
#| echo: false

tp_keep <- c("m12h_0h", "48h_72h")

vars <- c(
  "SOFA","PaFiO2","lactate","creatinine","albumin","C_react_protein",
  "procalcitonin","D_dimer","fibrinogen","leucocytes","lymphocytes",
  "neutrophils","thrombocytes","VIS2020"
)
vars <- intersect(vars, names(patients_tidy))

patients_paired <-
  patients_tidy %>%
  semi_join(ids_lps_72h, by = "pat_record_id") %>%
  filter(timepoint %in% tp_keep) %>%
  mutate(timepoint = factor(timepoint, levels = tp_keep)) %>%
  # filter(.by = pat_record_id, n_distinct(timepoint) == 2) %>%
  select(pat_record_id, timepoint, any_of(vars))

tbl <-
  patients_paired %>%
  tbl_summary(
    by = timepoint,
    include = -pat_record_id,
    statistic = all_continuous() ~ "{median} ({p25}, {p75})",
    missing = "ifany"
  ) %>%
  
  # add_p(
  #   test  = all_continuous() ~ "paired.t.test",
  #   group = pat_record_id
  # ) %>%
  add_difference(
    test  = all_continuous() ~ "paired.t.test",
    group = pat_record_id

  ) %>%
  modify_caption("Парные сравнения -12-0 и 48-72 часов, только LPS") %>%
  bold_labels()

tbl
```

Графики (только LPS)

```{r}

#| label: plots_m12h_0h_48h_72h
#| cache: true
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 4

# Ожидается, что vars, tp_keep и patients_paired уже существуют
vars_plot <- vars

# Логарифмируем ось Y только для выбранных переменных
vars_log_Y <- c("lactate", "D_dimer", "lymphocytes", "procalcitonin")

plot_long <- patients_paired %>%
  select(pat_record_id, timepoint, any_of(vars_plot)) %>%
  pivot_longer(
    cols = -c(pat_record_id, timepoint),
    names_to = "variable",
    values_to = "value"
  ) %>%
  mutate(
    timepoint = factor(timepoint, levels = tp_keep),
    variable  = factor(variable, levels = vars_plot)
  )

q <- function(x, p) {
  if (all(is.na(x))) NA_real_
  else as.numeric(quantile(x, p, na.rm = TRUE, names = FALSE))
}

stats_data <- plot_long %>%
  group_by(variable, timepoint) %>%
  summarise(
    n   = sum(!is.na(value)),
    Me  = if (all(is.na(value))) NA_real_ else median(value, na.rm = TRUE),
    Q1  = q(value, 0.25),
    Q3  = q(value, 0.75),
    P05 = q(value, 0.05),
    P95 = q(value, 0.95),
    .groups = "drop"
  )

make_plot <- function(var_name) {
  df_stat <- stats_data %>% filter(variable == var_name)
  df_raw  <- plot_long  %>% filter(variable == var_name) %>% drop_na(value)

  # Для лог-шкалы убираем нули/отрицательные (иначе -Inf)
  if (as.character(var_name) %in% vars_log_Y) {
    df_raw  <- df_raw  %>% filter(value > 0)
    df_stat <- df_stat %>% mutate(
      # ничего не пересчитываем здесь, просто оставляем как есть;
      # если хотите, можно пересчитать stats_data на value>0, но это уже усложнение
      n = n
    )
  }

  df_line <- df_raw %>%
    group_by(pat_record_id) %>%
    filter(n_distinct(timepoint) == 2, n() == 2) %>%
    ungroup()

  p <- ggplot() +
    geom_boxplot(
      data = df_stat,
      aes(
        x = timepoint,
        ymin = P05, ymax = P95,
        lower = Q1, middle = Me, upper = Q3
      ),
      stat = "identity",
      outlier.shape = NA,
      alpha = 0.4
    ) +
    geom_line(
      data = df_line,
      aes(x = timepoint, y = value, group = pat_record_id),
      alpha = 0.25
    ) +
    geom_point(
      data = df_raw,
      aes(x = timepoint, y = value),
      position = position_jitter(width = 0.008, height = 0),
      size = 0.9,
      alpha = 0.35
    ) +
    labs(title = as.character(var_name), x = NULL, y = NULL) +
    theme_bw()

  # Лог-шкала только для выбранных переменных
  if (as.character(var_name) %in% vars_log_Y) {
    p <- p + scale_y_log10(expand = expansion(mult = c(0.1, 0.1)))
  }

  p
}

plots_list <- vars_plot %>%
  set_names() %>%
  purrr::map(make_plot)

# Показать все графики в отчёте
purrr::walk(plots_list, print)

# (опционально) сохранить в PNG
# dir.create("plots_m12h_0h_48h_72h", showWarnings = FALSE)
# 
# purrr::iwalk(
#   plots_list,
#   ~ ggsave(
#     filename = file.path(
#       "plots_m12h_0h_48h_72h",
#       paste0(stringr::str_remove_all(.y, "[^[:alnum:]_]+"), ".png")
#     ),
#     plot = .x,
#     width = 7, height = 4, dpi = 300
#   )
# )
```

```{r}

#| label: plots_m12h_0h_48h_72h
#| cache: true
#| warning: false
#| message: false
#| fig-width: 12
#| fig-height: 8

library(ggh4x)   # install.packages("ggh4x") # если не установлен

# Ожидается, что vars, tp_keep и patients_paired уже существуют
vars_plot <- vars
vars_log_Y <- c("lactate", "D_dimer", "lymphocytes", "procalcitonin")

plot_long <- patients_paired %>%
  select(pat_record_id, timepoint, any_of(vars_plot)) %>%
  pivot_longer(
    cols = -c(pat_record_id, timepoint),
    names_to = "variable",
    values_to = "value"
  ) %>%
  mutate(
    timepoint = factor(timepoint, levels = tp_keep),
    variable_chr = as.character(variable),
    is_log = variable_chr %in% vars_log_Y,

    # для лог-переменных убираем 0 и отрицательные (иначе log10 даст -Inf и предупреждения)
    value = if_else(is_log & !is.na(value) & value <= 0, NA_real_, as.numeric(value)),

    # подпись панели (помечаем лог-переменные)
    variable_facet = if_else(is_log,
                             paste0(variable_chr, " (log10-axis)"),
                             variable_chr),
    variable_facet = factor(
      variable_facet,
      levels = if_else(vars_plot %in% vars_log_Y,
                       paste0(vars_plot, " (log10-axis)"),
                       vars_plot)
    )
  ) %>%
  drop_na(value)

# линии только для complete pairs по переменной
plot_lines <- plot_long %>%
  group_by(variable_facet, pat_record_id) %>%
  filter(n_distinct(timepoint) == 2, n() == 2) %>%
  ungroup()

p <- ggplot(plot_long, aes(x = timepoint, y = value)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.35) +
  geom_line(data = plot_lines, aes(group = pat_record_id), alpha = 0.20) +
  geom_point(position = position_jitter(width = 0.08, height = 0),
             size = 0.9, alpha = 0.35) +
  facet_wrap(~ variable_facet, scales = "free_y", ncol = 4) +
  # применяем log10-шкалу только к нужным панелям
  ggh4x::facetted_pos_scales(
    y = list(
      variable_facet == "lactate (log10-axis)"       ~ scale_y_log10(expand = expansion(mult = c(0.1, 0.1))),
      variable_facet == "D_dimer (log10-axis)"       ~ scale_y_log10(expand = expansion(mult = c(0.1, 0.1))),
      variable_facet == "lymphocytes (log10-axis)"   ~ scale_y_log10(expand = expansion(mult = c(0.1, 0.1))),
      variable_facet == "procalcitonin (log10-axis)" ~ scale_y_log10(expand = expansion(mult = c(0.1, 0.1))),
      TRUE ~ scale_y_continuous(expand = expansion(mult = c(0.05, 0.1)))
    )
  ) +
  labs(x = NULL, y = NULL) +
  theme_bw()

p
```
